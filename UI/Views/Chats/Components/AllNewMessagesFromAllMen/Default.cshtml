@using Humanizer
@model IEnumerable<(Dialogue Dialogue, SheetInfo SheetInfo)>

@{
    var timers = (Dictionary<long, MessageTimer>)ViewData["timers"];
}

@foreach (var ds in Model)
{

    //Проверяем кто написал последнее сообщение в диалоге, владелица анкеты или мужчина. Если условие выполняется, то сообщение написал владелица анкеты
    if (ds.SheetInfo.Id == ds.Dialogue.LastMessage.IdUserFrom)
    @*if (!ds.Dialogue.HasNewMessage)*@
    {
        <div name="newMessage" class="bottom-block-body__item d-flex w-100 cursor-pointer flex-row-reverse mb-2 align-items-center text-white row p-2 rounded"
             data-sheet-id="@($"{ds.SheetInfo.SheetId}")"
             data-owner-id="@($"{ds.SheetInfo.Id}")"
             data-is-pinned="@ds.Dialogue.IsPinned"
             data-is-bookmarked="@ds.Dialogue.IsBookmarked"
             data-message-type="@(ds.Dialogue.LastMessage.Type == MessageType.System ? MessageType.System : "")"
             data-online="@ds.Dialogue.Status"
             onclick="goToChat(this)">

            <div class="other-user-block col-2 pe-0">
                <div class="position-relative">
                    <img name="interlocutorAvatar" src="@ds.Dialogue.Avatar" alt="No person image" class="standart-image rounded">
                    @if (ds.Dialogue.Status == Status.Online)
                    {
                        <span class="status-circle-green other-user-block-status rounded-circle d-inline-block position-absolute bottom-0"></span>
                    }
                    else
                    {
                        <span class="status-circle-red other-user-block-status rounded-circle d-inline-block position-absolute bottom-0"></span>
                    }
                </div>

                @*<p name="interlocutorName" class="d-none">@ds.Dialogue.UserName</p>*@
                <p name="interlocutorId" class="d-none">@ds.Dialogue.IdInterlocutor</p>

                <p name="interlocutorName" class="user-block-name-text small-text-wrapp">
                    @ds.Dialogue.UserName
                </p>
            </div>
            <div class="message-block col-6 text-start pe-0">
                <p class="mb-1 other-name-text-mutiline">
                    @switch (ds.Dialogue.LastMessage.Type)
                    {
                        case MessageType.Message:
                            @ds.Dialogue.LastMessage.Content.Message
                            break;

                        case MessageType.Sticker:
                            @:Sticker
                            break;

                        case MessageType.Virtual_Gift:
                            @:Gift
                            break;

                        case MessageType.Photo:
                        case MessageType.Photo_batch:
                            @:Photo
                            break;

                        case MessageType.LikePhoto:
                            @:Like Photo
                            break;

                        case MessageType.Video:
                            @:Video
                            break;

                        case MessageType.Post:
                            @:Post
                            break;

                        case MessageType.Like_NewsFeed_Post:
                            @:Like Post
                            break;

                        case MessageType.Wink:
                            @:Winked
                            break;

                        case MessageType.System:
                            @ds.Dialogue.LastMessage.Content.Message
                            break;

                        default:
                            break;
                    }
                </p>
                <p class="user-block-name-text opacity-50">
                    @ds.Dialogue.LastMessage.DateCreated.Humanize()
                </p>
            </div>
            <div class="user-block d-flex align-items-center rounded col-4 p-2">
                <div class="me-3 position-relative">
                    <img name="ownerAvatar" src="@ds.SheetInfo.Personal.AvatarSmall" alt="Person image" class="standart-image rounded">
                    @*                    @if (sd.SheetInfo.IsOnline)
            {
            <span class="status-circle-green rounded-circle d-inline-block position-absolute bottom-0 end-0"></span>
            }
            else
            {
            <span class="status-circle-red rounded-circle d-inline-block position-absolute bottom-0 end-0"></span>
            }*@
                </div>

                <div class="text-center col-4">
                    <p name="ownerName" class="user-block-name-text">@ds.SheetInfo.Personal.Name</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div name="newMessage" class="bottom-block-body__item d-flex w-100 cursor-pointer flex-row align-items-center text-white row p-2 rounded mb-2"
             data-sheet-id="@($"{ds.SheetInfo.SheetId}")"
             data-owner-id="@($"{ds.SheetInfo.Id}")"
             data-is-pinned="@ds.Dialogue.IsPinned"
             data-is-bookmarked="@ds.Dialogue.IsBookmarked"
             data-message-type="@ds.Dialogue.LastMessage.Type"
             data-online="@ds.Dialogue.Status"
             onclick="goToChat(this)">

            <div class="other-user-block col-2 ps-0">
                <div class="position-relative">
                    <img name="interlocutorAvatar" src="@ds.Dialogue.Avatar" alt="No person image" class="standart-image rounded">
                    @if (ds.Dialogue.Status == Status.Online)
                    {
                        <span class="status-circle-green other-user-block-status rounded-circle d-inline-block position-absolute bottom-0"></span>
                    }
                    else
                    {
                        <span class="status-circle-red other-user-block-status rounded-circle d-inline-block position-absolute bottom-0"></span>
                    }
                </div>

                <p name="interlocutorName" class="user-block-name-text small-text-wrapp">
                    @ds.Dialogue.UserName
                </p>

            </div>
            <div class="message-block col-6 text-start ps-0">
                @*<p name="interlocutorName" class="mb-1 other-name-text">@ds.Dialogue.UserName</p>*@
                <p name="interlocutorId" class="d-none">@ds.Dialogue.IdInterlocutor</p>
                <p class="other-name-text-mutiline">
                    @switch (ds.Dialogue.LastMessage.Type)
                    {
                        case MessageType.Message:
                            @: @ds.Dialogue.LastMessage.Content.Message
                            break;

                        case MessageType.Sticker:
                            @:Sticker
                            break;

                        case MessageType.Virtual_Gift:
                            @:Gift
                            break;

                        case MessageType.Photo:
                        case MessageType.Photo_batch:
                            @:Photo
                            break;

                        case MessageType.LikePhoto:
                            @:Like Photo
                            break;

                        case MessageType.Video:
                            @:Video
                            break;

                        case MessageType.Post:
                            @:Post
                            break;

                        case MessageType.Like_NewsFeed_Post:
                            @:Like Post
                            break;

                        case MessageType.Wink:
                            @:Winked
                            break;

                        case MessageType.System:
                            @ds.Dialogue.LastMessage.Content.Message
                            break;

                        default:
                            break;
                    }
                </p>
                <p class="user-block-name-text opacity-50">
                    @if (ds.Dialogue.LastMessage.Type == MessageType.System)
                    {
                        @:@ds.Dialogue.DateUpdated.Humanize()
                    }
                    else
                    {
                        @:@ds.Dialogue.LastMessage.DateCreated.Humanize()
                    }
                </p>
            </div>
            <div class="user-block d-flex align-items-center rounded col-4 p-2">
                <div class="me-3 position-relative">
                    <img name="ownerAvatar" src="@ds.SheetInfo.Personal.AvatarSmall" alt="Person image" class="standart-image rounded">
                    @*                   @if (sd.SheetInfo.IsOnline)
            {
            <span class="status-circle-green rounded-circle d-inline-block position-absolute bottom-0 end-0"></span>
            }
            else
            {
            <span class="status-circle-red rounded-circle d-inline-block position-absolute bottom-0 end-0"></span>
            }*@
                </div>

                <div class="text-center col-4">
                    <p name="ownerName" class="user-block-name-text">@ds.SheetInfo.Personal.Name</p>
                    <p class="user-block-timer-text timer" @*data-minutes-left="1"*@ data-seconds-left="@(ds.Dialogue.LastMessage.Timer?.TimeLeft() ?? 0)" data-sheetInfo-id="@ds.SheetInfo.Id" data-id-interlocutor="@ds.Dialogue.IdInterlocutor"></p>
                </div>
            </div>
        </div>
    }
}